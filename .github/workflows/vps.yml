name: VPS-Ubuntu-CF

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # tối đa 6 giờ

    steps:
    - name: Cài SSH server & user
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server
        sudo service ssh start
        sudo useradd -m vps -s /bin/bash
        echo 'vps:vpspass' | sudo chpasswd
        echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart

    - name: Cài đặt cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Chạy tunnel & giữ VPS
      run: |
        # Tạo tunnel TCP cho SSH
        cloudflared tunnel --url tcp://localhost:22 > tunnel.log 2>&1 &
        sleep 10
        echo "==== Thông tin tunnel ===="
        grep -o "tcp://[0-9a-zA-Z.:]*" tunnel.log || true
        echo "=========================="

        # Giữ job sống tới khi hết 6h
        tail -f /dev/null
