name: VPS-Ubuntu

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt update
          sudo apt install -y openssh-server wget
          sudo service ssh start
          # tạo user vps và set pass
          sudo useradd -m -s /bin/bash vps
          echo "vps:vpspass" | sudo chpasswd
          # bật login bằng password
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Cài Cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Mở tunnel SSH
        run: |
          nohup cloudflared tunnel --url tcp://localhost:22 --protocol tcp > tunnel.log 2>&1 &
          sleep 15
          grep -Eo "tcp://[0-9a-zA-Z.-]+:[0-9]+" tunnel.log | tail -n 1 > cf.txt
          echo "===== SSH INFO ====="
          echo "Host: $(cut -d: -f2 cf.txt | sed 's#//##')"
          echo "Port: $(cut -d: -f3 cf.txt)"
          echo "User: vps"
          echo "Pass: vpspass"
          echo "===================="

      - name: Giữ VPS chạy
        run: |
          echo "VPS đang chạy... không tắt job."
          sleep infinity
