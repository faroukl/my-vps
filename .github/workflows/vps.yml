name: VPS-Ubuntu-CF

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Cài SSH server & user
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server
        sudo service ssh start
        sudo useradd -m vps -s /bin/bash
        echo 'vps:vpspass' | sudo chpasswd
        echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart

    - name: Cài đặt cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Chạy tunnel & giữ VPS
      run: |
        # Tạo quick tunnel và log ra file
        cloudflared tunnel --no-autoupdate --url tcp://localhost:22 --logfile tunnel.log &
        sleep 20
        echo "==== Thông tin tunnel (dùng để SSH) ===="
        grep -o "tcp://[0-9a-zA-Z.:-]*trycloudflare.com:[0-9]*" tunnel.log || true
        echo "========================================"
        # Giữ VPS sống
        tail -f /dev/null
